<fieldset>
  <legend>Disease Investigation
  <span id='investigation_hide' onClick="Element.hide('investigation_form'); Element.hide('investigation_hide'); Element.show('investigation_show'); return false;">[Hide]</span>
  <span id='investigation_show' onClick="Element.show('investigation_form'); Element.hide('investigation_show'); Element.show('investigation_hide'); return false;" style="display: none;">[Show]</span>
  </legend>
  <div id ='investigation_form'>
    <% if @event.form_references.empty? %>
      <h3>No investigation forms exist for <%= @event.disease.disease.disease_name %></h3>
    <% else %>
      <script type="text/javascript">
        var formTabs = new YAHOO.widget.TabView("form_tabs");
      </script>
      <div id="form_tabs" class="yui-navset">
        <ul id='sub_form_tabs' class="yui-nav">
          <% i = section_ctr = 0 -%>
          <% for form_reference in @event.form_references -%>
            <% i += 1 %>
            <li <%= 'class="selected"' if i == 1 -%>><a href="#form_<%= form_reference.form.id -%>"><em><%= form_reference.form.name %></em></a></li>
          <% end -%>
        </ul>
        <div class="yui-content">
          
          <% for @form_reference in @event.form_references %>
            <% _form = @form_reference.form %>
            <div id="form_<%= _form.id -%>">
              <% f.fields_for(:form_references, @form_reference, :builder => ExtendedFormBuilder) do |fr| %>
                <%= fr.hidden_field(:form_id, :index => @form_reference.id) %>
              <% end %>
              <h2><%= _form.description %></h2>
              <% section_open = false -%>
              <% _form.form_base_element.pre_order_walk do |element| -%>
                <% case element.class.name
                   when "SectionElement" %>
                     <%= "</div></fieldset>" if section_open %>
                     <% section_open = true %>
                     <% section_ctr += 1; section_id = "section_#{section_ctr}"; hide_id = section_id + "_hide"; show_id = section_id + "_show" %>
                     <fieldset class="form_section">
                       <legend><%= element.name -%>
                         <span id='<%= hide_id %>' onClick="Element.hide('<%= section_id %>'); Element.hide('<%= hide_id %>'); Element.show('<%= show_id %>'); return false;">[Hide]</span>
                         <span id='<%= show_id %>' onClick="Element.show('<%= section_id %>'); Element.hide('<%= show_id %>'); Element.show('<%= hide_id %>'); return false;" style="display: none;">[Show]</span>
                       </legend>
                       <div id='<%= section_id %>'>
                         <h3><%= element.description -%></h3>
                <% when "CoreViewElement"
                  # Debt: This will have to change
                  break -%>
                <% when "QuestionElement" -%>
                    <% @answer_object = @event.get_or_initialize_answer(element.question.id) -%>
                    <% f.fields_for(:answers, @answer_object, :builder => ExtendedFormBuilder) do |answer_template| %>
                        <%= answer_template.dynamic_question(element, @form_index += 1) %>
                    <% end -%>
                    <p />
                  <% when "CoreDataElement" -%>
                    <%= render_core_data_element(element) %>
                <% end -%>
              <% end %>
              <%= "</fieldset>" if section_open %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</fieldset>
