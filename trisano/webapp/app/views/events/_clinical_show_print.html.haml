-# Copyright (C) 2007, 2008, The Collaborative Software Foundation
-#
-# This file is part of TriSano.
-#
-# TriSano is free software: you can redistribute it and/or modify it under the terms of the
-# GNU Affero General Public License as published by the Free Software Foundation, either 
-# version 3 of the License, or (at your option) any later version.
-#
-# TriSano is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; 
-# without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  
-# See the GNU Affero General Public License for more details.
-# 
-# You should have received a copy of the GNU Affero General Public License along with TriSano. 
-# If not, see http://www.gnu.org/licenses/agpl-3.0.txt.


%span.section-header
  Clinical Information

- event_form.fields_for(:disease, @event.disease, :builder => ExtendedFormBuilder) do |d|
  - core_element_print :disease_id, d, :horiz do
    %span.print-label Disease:
    %span.print-value= @event.disease.disease.disease_name unless @event.disease.nil? || @event.disease.disease.nil?
  - core_element_print :disease_onset_date, d, :horiz do
    %span.print-label Onset date
    %span.print-value= @event.disease.disease_onset_date unless @event.disease.nil? || @event.disease.disease.nil?
  - core_element_print :date_diagnosed, d, :horiz do
    %span.print-label Date diagnosed:
    %span.print-value= @event.disease.date_diagnosed unless @event.disease.nil? || @event.disease.disease.nil?
  - core_element_print :hospitalized_id, d, :horiz do
    %span.print-label Hospitalized:
    %span.print-value= l @event.disease.hospitalized unless @event.disease.nil?
  - core_element_print :died_id, d, :horiz do
    %span.print-label Died:
    %span.print-value= l @event.disease.died unless @event.disease.nil?

- event_form.fields_for(:active_patient, @event.active_patient, :builder => ExtendedFormBuilder) do |active_patient_form|
  - active_patient_form.fields_for(:active_primary_entity, @event.active_patient.primary_entity, :builder => ExtendedFormBuilder) do |primary_form|
    - primary_form.fields_for(:person, @event.active_patient.primary_entity.person, :builder => ExtendedFormBuilder) do |person_form|
      - core_element_print :date_of_death, person_form, :vert do
        %span.print-label Date of death:
        %span.print-value= entity_data.person.date_of_death

- event_form.fields_for(:active_patient, @event.active_patient, :builder => ExtendedFormBuilder) do |patient_fields|
  - patient_fields.fields_for(:participations_risk_factor, @event.active_patient.participations_risk_factor, :builder => ExtendedFormBuilder) do |risk_factor_form|
    - core_element_print :pregnant_id, risk_factor_form, :horiz do
      %span.print-label Pregnant:
      %span.print-value= l @event.active_patient.participations_risk_factor.pregnant unless @event.active_patient.nil? or @event.active_patient.participations_risk_factor.nil?
    - core_element_print :pregnancy_due_date, risk_factor_form, :horiz do
      %span.print-label Pregnancy due date:
      %span.print-value= @event.active_patient.participations_risk_factor.pregnancy_due_date unless @event.active_patient.nil? or @event.active_patient.participations_risk_factor.nil?

%br
%span.subsection-header Diagnosing health facilities
- if @event.diagnosing_health_facilities.empty?
  %b No diganosing health facilities have been recorded for this event
- else
  %ul
    - for diagnostic in @event.diagnosing_health_facilities
      %li.print-value
        = diagnostic.secondary_entity.place_temp.name

%span.subsection-header Hospitalized health facilities
- if @event.hospitalized_health_facilities.empty?
  %b No hospitalized health facilities have been recorded for this event
- else
  .three-valued-row
    .long
      %span.print-label Hospitalized health facility
    .short
      %span.print-label Admission date
    .short
      %span.print-label Discharge date
    .short
      %span.print-label Record Number
    %br
    %hr
    - for hospital in @event.hospitalized_health_facilities
      .three-valued-row
        .long
          %span.print-value
            = hospital.secondary_entity.place_temp.name
        .short
          %span.print-value
            = hospital.hospitals_participation.admission_date unless hospital.hospitals_participation.nil?
        .short
          %span.print-value
            = hospital.hospitals_participation.discharge_date unless hospital.hospitals_participation.nil?
        .short
          %span.print-value
            = hospital.hospitals_participation.medical_record_number unless hospital.hospitals_participation.nil?
%br

%span.subsection-header
  Treatments

- unless @event.disease.nil? || @event.disease.disease.nil? || @event.disease.disease.treatment_lead_in.blank?
  %span.print-label=h @event.disease.disease.treatment_lead_in
  %br
  %br

- core_element_print :treatments, event_form, :vert do
  - if @event.active_patient.participations_treatments.empty?
    %b No treatments have been recorded for this case
  - else
    .three-valued-row
      %dif.left
        %span.print-label Treatment
      .left
        %span.print-label Treatment Given
      %br
      %hr
      - for treatment in @event.active_patient.participations_treatments
        .three-valued-row
          .left
            %span.print-value
              = treatment.treatment
          .left
            %span.print-value
              = l treatment.treatment_given_yn

%span.subsection-header Clinicians
%br
- if @event.clinicians.empty?
  %b No clinicians have been recorded for this case
- else
  .three-valued-row
    .left
      %span.print-label Name
    .left
      %span.print-label Phone
    %br
    %hr

    - for clinician in @event.clinicians
      - clinician_entity = clinician.secondary_entity
      - clinician_person = clinician_entity.person_temp

      - clinician_phone_loc = clinician_entity.telephone_entities_locations.last
      - clinician_phone = clinician_phone_loc.location.telephones.last unless clinician_phone_loc.nil?

      .three-valued-row
        .left
          %span.print-value
            = clinician_person.last_name + (clinician_person.first_name.blank? ? "" : fml(", ", clinician_person.first_name, ""))
        .left
          %span.print-value
            -unless clinician_phone_loc.nil?
              = (l(clinician_phone_loc.entity_location_type) || "Unspecified Locaiton") + ": " + clinician_phone.simple_format





